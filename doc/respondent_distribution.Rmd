---
title: "Respondent Distribution"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(leaflet)
library(shiny)
library(plotly)

lit <- read.csv("../data/processed_data.csv")

lit_landlord <- lit %>% group_by(BuildingID) %>% tally()
lit_geo <- lit %>% dplyr::select(BuildingID, Latitude, Longitude, StreetName, HouseNumber, Respondent)
lit_landlord_geo <- left_join(lit_landlord, lit_geo, by = "BuildingID")
```

```{r}
ui <- fluidPage(
  
  h1("Litigations of each Building"),
  
  sidebarLayout(
    
    sidebarPanel(
       textInput("text", label = h3("Search"), value = "Enter Respondent"),
       actionButton( "search","Search"),
       br(),
       plotlyOutput("histogram", height = 350)
    ),
    
    mainPanel(
      leafletOutput("mymap",height = 800)
    )
    
  )
)
```


```{r}
server <- function(input, output) {
  
  output$mymap <- renderLeaflet({
    input$search
    data <- filter(lit_landlord_geo, Respondent == isolate(input$text))
    m <- leaflet(data = data) %>%
      addTiles() %>%
      setView(lng = -73.9588,
              lat = 40.74 ,
              zoom = 11) %>%
      addProviderTiles("CartoDB.Positron") %>%
      addCircleMarkers(
        lng = ~ Longitude,
        lat = ~ Latitude,
        popup = ~ paste0(
          "Address: ",
          HouseNumber,
          " ",
          StreetName,
          "<br/>Litigations: " ,
          n,

        ),
        radius = 4,
        color = "red",
        fillColor = "white",
        opacity = 0.5
      )
  })
  
  
  
  output$histogram <- renderPlotly({
    input$search
    data <- filter(lit_landlord_geo, Respondent == isolate(input$text))
    if (nrow(data) == 0) {
      return(NULL)
    }
    
    ts_data <- group_by(data, BuildingID) %>% tally()
    colnames(ts_data) <-
      c("BuildingID", "Number of litigations")
    ts_data <-
      group_by(ts_data, `Number of litigations`) %>% tally()
    colnames(ts_data) <-
      c("Number of litigations", "Number of buildings")
    
    ts <-
      ggplot(ts_data,
             aes(x = `Number of litigations`, y = `Number of buildings`)) +
      geom_bar(stat = "identity") +
      ggtitle("Histogram of buildings per litigation number") +
      labs(x = "Number of litigations", y = "Number of buildings") #+ coord_flip()
    ts <- ggplotly(ts)
    ts
  })
  
}

shinyApp(ui, server)

```
